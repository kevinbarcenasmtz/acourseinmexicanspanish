---
/**
 * LeftSidebar.astro
 *
 * Main navigation sidebar with:
 * - Content Collection lesson fetching
 * - Collapsible sections (CSS Grid 0fr → 1fr animation)
 * - Keyboard navigation (↑↓←→ Home/End, / for search)
 * - Search filtering
 * - localStorage state persistence (collapsed sections, width)
 * - Resizable with drag handle
 */

import { getCollection } from 'astro:content';
import { staticPages, frontMatter, appendices } from '../lib/nav-data';
import NavSection from './NavSection.astro';
import ThemeToggle from './ThemeToggle.astro';

interface Props {
  currentPath?: string;
  /** Context identifier to make IDs unique (e.g., 'desktop', 'mobile') */
  context?: string;
}

const { currentPath = '', context = 'desktop' } = Astro.props;
const searchInputId = `sidebar-search-${context}`;

// Fetch all lessons from content collection
const allLessons = await getCollection('lessons');

// Sort by order and group by section
const lessonsBySection = allLessons
  .sort((a, b) => a.data.order - b.data.order)
  .reduce(
    (acc, lesson) => {
      const section = lesson.data.section;
      if (!acc[section]) {
        acc[section] = [];
      }
      acc[section].push({
        slug: lesson.slug,
        title: lesson.data.title,
        href: `/lessons/${lesson.slug}`,
      });
      return acc;
    },
    {} as Record<string, Array<{ slug: string; title: string; href: string }>>,
  );
---

<div id="left-sidebar-container" class="sidebar-container" style="width: 100%;" data-sidebar-context={context}>
  <div class="sidebar-content">
    <!-- Search Bar -->
    <div class="p-4 pb-2">
      <div class="relative">
        <svg
          class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-secondary pointer-events-none"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input
          type="text"
          id={searchInputId}
          placeholder="Search lessons... (Press /)"
          class="search-input"
          aria-label="Search navigation"
          data-sidebar-context={context}
        />
      </div>
    </div>

    <!-- Navigation -->
    <nav class="sidebar-nav p-4 pt-2" aria-label="Main navigation">
      <!-- Static Top Links -->
      <div class="mb-4 space-y-1">
        <a
          href={staticPages.home.href}
          class:list={['nav-item', { active: currentPath === '/' }]}
          data-nav-item
        >
          {staticPages.home.title}
        </a>
        <a
          href={staticPages.about.href}
          class:list={['nav-item', { active: currentPath === '/about' }]}
          data-nav-item
        >
          {staticPages.about.title}
        </a>
      </div>

      <!-- Divider -->
      <div class="my-3 h-px bg-border"></div>

      <!-- Front Matter Section -->
      <NavSection
        sectionId="front-matter"
        title="Front Matter"
        items={frontMatter}
        currentPath={currentPath}
      />

      <!-- Foundation Section -->
      {lessonsBySection.Foundation && (
        <NavSection
          sectionId="foundation"
          title="Foundation"
          items={lessonsBySection.Foundation}
          currentPath={currentPath}
        />
      )}

      <!-- Intermediate Section -->
      {lessonsBySection.Intermediate && (
        <NavSection
          sectionId="intermediate"
          title="Intermediate"
          items={lessonsBySection.Intermediate}
          currentPath={currentPath}
        />
      )}

      <!-- Advanced Section -->
      {lessonsBySection.Advanced && (
        <NavSection
          sectionId="advanced"
          title="Advanced"
          items={lessonsBySection.Advanced}
          currentPath={currentPath}
        />
      )}

      <!-- Appendices Section -->
      <NavSection
        sectionId="appendices"
        title="Appendices"
        items={appendices}
        currentPath={currentPath}
      />

      <!-- Divider -->
      <div class="my-3 h-px bg-border"></div>

      <!-- Dark Mode Toggle -->
      <div class="nav-item w-full justify-start p-0">
        <ThemeToggle showLabel={true} variant="button" />
      </div>
    </nav>
  </div>

  <!-- Resize Handle -->
  <div
    class="resize-handle"
    role="separator"
    aria-label="Resize sidebar"
    aria-orientation="vertical"
  >
  </div>
</div>

<script>
  import { initSidebar } from '../lib/sidebar/index';

  // #region agent log
  function logDuplicateIDCheck() {
    const searchInputs = document.querySelectorAll('[id^="sidebar-search-"]');
    const count = searchInputs.length;
    const locations = Array.from(searchInputs).map((el) => {
      const inputEl = el;
      const parent = inputEl.closest('aside, .drawer, .sidebar-container');
      const isVisible = 'offsetParent' in inputEl ? inputEl.offsetParent !== null : false;
      return {
        id: inputEl.id,
        parentId: parent?.id || parent?.className || 'unknown',
        isVisible: isVisible,
        context: inputEl.getAttribute('data-sidebar-context') || 'unknown',
        location: parent?.closest('#left-sidebar') ? 'desktop-sidebar' : 
                 parent?.closest('#left-drawer') ? 'mobile-drawer' : 'unknown'
      };
    });
    
    fetch('http://127.0.0.1:7243/ingest/23eb47dd-4f31-40a6-99f9-107b58697ad1', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        location: 'LeftSidebar.astro:168',
        message: 'Post-fix: ID check - sidebar-search inputs found',
        data: { count, locations, allIds: Array.from(searchInputs).map(el => el.id) },
        timestamp: Date.now(),
        sessionId: 'debug-session',
        runId: 'post-fix',
        hypothesisId: 'A'
      })
    }).catch(() => {});
    
    if (count > 1) {
      const duplicateIds = Array.from(searchInputs).map(el => el.id);
      const hasDuplicates = new Set(duplicateIds).size !== duplicateIds.length;
      if (hasDuplicates) {
        fetch('http://127.0.0.1:7243/ingest/23eb47dd-4f31-40a6-99f9-107b58697ad1', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            location: 'LeftSidebar.astro:168',
            message: 'DUPLICATE ID STILL DETECTED',
            data: { duplicateCount: count, locations, duplicateIds },
            timestamp: Date.now(),
            sessionId: 'debug-session',
            runId: 'post-fix',
            hypothesisId: 'A'
          })
        }).catch(() => {});
      } else {
        fetch('http://127.0.0.1:7243/ingest/23eb47dd-4f31-40a6-99f9-107b58697ad1', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            location: 'LeftSidebar.astro:168',
            message: 'FIX VERIFIED: All IDs are unique',
            data: { count, locations, allIds: duplicateIds },
            timestamp: Date.now(),
            sessionId: 'debug-session',
            runId: 'post-fix',
            hypothesisId: 'A'
          })
        }).catch(() => {});
      }
    }
  }
  // #endregion

  // Wait for DOM to be fully loaded
  document.addEventListener('DOMContentLoaded', () => {
    // #region agent log
    logDuplicateIDCheck();
    // #endregion
    
    // Find all sidebar containers and initialize each one's search
    const containers = document.querySelectorAll('[data-sidebar-context]');
    containers.forEach((container) => {
      const context = container.getAttribute('data-sidebar-context');
      const searchInputId = `sidebar-search-${context}`;
      const searchInput = document.getElementById(searchInputId);
      if (searchInput) {
        initSidebar(searchInputId);
      }
    });
  });

  // Re-initialize on Astro navigation
  document.addEventListener('astro:after-swap', () => {
    // #region agent log
    logDuplicateIDCheck();
    // #endregion
    
    // Find all sidebar search inputs and initialize each one
    const searchInputs = document.querySelectorAll('[id^="sidebar-search-"]');
    searchInputs.forEach((input) => {
      initSidebar(input.id);
    });
  });
</script>

<style>
  .sidebar-container {
    position: relative;
    display: flex;
    flex-direction: row;
    height: 100%;
  }

  .sidebar-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-nav {
    flex: 1;
    overflow-y: auto;
  }

  /* Navigation Section */
  .nav-section {
    margin-bottom: 0.75rem;
  }

  /* Section Header */
  .nav-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 0.625rem 0.75rem;
    background: transparent;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: background-color var(--transition-fast);
  }

  .nav-section-header:hover {
    background-color: var(--color-bg-tertiary);
  }

  /* Expanded section header has accent background */
  .nav-section.expanded .nav-section-header {
    background-color: var(--color-accent-bg);
  }

  /* Chevron Icon (▶/▼) */
  .nav-section-icon {
    font-size: 1rem;
    font-weight: 400;
    line-height: 1;
    color: var(--color-text-secondary);
    display: inline-block;
    transition: transform 0.2s ease-out;
    transform: rotate(0deg);
  }

  /* Collapsed: chevron points right (▶) */
  .nav-section:not(.expanded) .nav-section-icon::before {
    content: '▶';
  }

  /* Expanded: chevron points down (▼) - rotated 90° */
  .nav-section.expanded .nav-section-icon {
    transform: rotate(90deg);
  }

  .nav-section.expanded .nav-section-icon::before {
    content: '▶';
  }

  /* Vertical bar for expanded sections */
  .nav-section-items {
    padding-top: 0.25rem;
    padding-left: 0.75rem;
    border-left: 8px solid var(--color-border);
    margin-left: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  /* Remove focus ring, use background tint instead */
  .nav-item:focus-visible {
    outline: none;
    background-color: var(--color-bg-tertiary);
  }

  /* Resize Handle */
  .resize-handle {
    width: 4px;
    cursor: col-resize;
    background: transparent;
    transition: background-color var(--transition-fast);
    flex-shrink: 0;
  }

  .resize-handle:hover {
    background-color: var(--color-accent);
  }

  /* Search Highlighting */
  .search-highlight {
    background-color: var(--color-accent-bg);
    color: var(--color-accent);
    font-weight: 600;
    padding: 0 0.125rem;
    border-radius: 0.125rem;
  }
</style>
