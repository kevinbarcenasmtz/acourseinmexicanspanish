---
/**
 * LeftSidebar.astro
 *
 * Main navigation sidebar with:
 * - Content Collection lesson fetching
 * - Collapsible sections (CSS Grid 0fr → 1fr animation)
 * - Keyboard navigation (↑↓←→ Home/End, / for search)
 * - Search filtering
 * - localStorage state persistence (collapsed sections, width)
 * - Resizable with drag handle
 */

import { getCollection } from 'astro:content';
import { staticPages, frontMatter, appendices } from '../lib/nav-data';
import NavSection from './NavSection.astro';
import ThemeToggle from './ThemeToggle.astro';

interface Props {
  currentPath?: string;
  /** Context identifier to make IDs unique (e.g., 'desktop', 'mobile') */
  context?: string;
}

const { currentPath = '', context = 'desktop' } = Astro.props;
const searchInputId = `sidebar-search-${context}`;

// Fetch all lessons from content collection
const allLessons = await getCollection('lessons');

// Sort by order and group by section
const lessonsBySection = allLessons
  .sort((a, b) => a.data.order - b.data.order)
  .reduce(
    (acc, lesson) => {
      const section = lesson.data.section;
      if (!acc[section]) {
        acc[section] = [];
      }
      acc[section].push({
        slug: lesson.slug,
        title: lesson.data.title,
        href: `/lessons/${lesson.slug}`,
      });
      return acc;
    },
    {} as Record<string, Array<{ slug: string; title: string; href: string }>>,
  );
---

<div
  id="left-sidebar-container"
  class="sidebar-container"
  style="width: 100%;"
  data-sidebar-context={context}
>
  <div class="sidebar-content">
    <!-- Search Bar -->
    <div class="p-4 pb-2">
      <div class="relative">
        <svg
          class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-secondary pointer-events-none"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input
          type="text"
          id={searchInputId}
          placeholder="Search lessons... (Press /)"
          class="search-input"
          aria-label="Search navigation"
          data-sidebar-context={context}
        />
      </div>
    </div>

    <!-- Navigation -->
    <nav class="sidebar-nav custom-scrollbar p-4 pt-2" aria-label="Main navigation">
      <!-- Static Top Links -->
      <div class="mb-4 space-y-1">
        <a
          href={staticPages.home.href}
          class:list={['nav-item', { active: currentPath === '/' }]}
          data-nav-item
          tabindex={currentPath === '/' ? 0 : -1}
        >
          {staticPages.home.title}
        </a>
        <a
          href={staticPages.about.href}
          class:list={['nav-item', { active: currentPath === '/about' }]}
          data-nav-item
          tabindex={currentPath === '/about' ? 0 : -1}
        >
          {staticPages.about.title}
        </a>
      </div>

      <!-- Divider -->
      <div class="my-3 h-px bg-border"></div>

      <!-- Front Matter Section -->
      <NavSection
        sectionId="front-matter"
        title="Front Matter"
        items={frontMatter}
        currentPath={currentPath}
      />

      <!-- Foundation Section -->
      {
        lessonsBySection.Foundation && (
          <NavSection
            sectionId="foundation"
            title="Foundation"
            items={lessonsBySection.Foundation}
            currentPath={currentPath}
          />
        )
      }

      <!-- Intermediate Section -->
      {
        lessonsBySection.Intermediate && (
          <NavSection
            sectionId="intermediate"
            title="Intermediate"
            items={lessonsBySection.Intermediate}
            currentPath={currentPath}
          />
        )
      }

      <!-- Advanced Section -->
      {
        lessonsBySection.Advanced && (
          <NavSection
            sectionId="advanced"
            title="Advanced"
            items={lessonsBySection.Advanced}
            currentPath={currentPath}
          />
        )
      }

      <!-- Appendices Section -->
      <NavSection
        sectionId="appendices"
        title="Appendices"
        items={appendices}
        currentPath={currentPath}
      />

      <!-- Divider -->
      <div class="my-3 h-px bg-border"></div>

      <!-- Dark Mode Toggle -->
      <div class="nav-item w-full justify-start p-0">
        <ThemeToggle showLabel={true} variant="button" />
      </div>
    </nav>
  </div>

  <!-- Resize Handle -->
  <div
    class="resize-handle"
    role="separator"
    aria-label="Resize sidebar"
    aria-orientation="vertical"
  >
  </div>
</div>

<script is:inline>
  // Run immediately to prevent flash - before CSS paints
  (function () {
    const COLLAPSED_KEY = 'sidebar-collapsed-sections';
    const WIDTH_KEY = 'sidebar-width';

    function getCollapsedSections() {
      try {
        const stored = localStorage.getItem(COLLAPSED_KEY);
        return stored ? JSON.parse(stored) : [];
      } catch {
        return [];
      }
    }

    // Restore sidebar width immediately (desktop only)
    if (window.innerWidth >= 1024) {
      const storedWidth = localStorage.getItem(WIDTH_KEY);
      if (storedWidth) {
        const sidebar = document.getElementById('left-sidebar');
        const gridContainer = document.querySelector('.app-body');
        if (sidebar && gridContainer) {
          const width = parseInt(storedWidth, 10);
          // Apply without transition
          sidebar.style.transition = 'none';
          gridContainer.style.transition = 'none';
          sidebar.style.width = width + 'px';

          // Get ToC width for grid
          const tocWidth =
            getComputedStyle(document.documentElement).getPropertyValue('--toc-width').trim() ||
            '200px';
          gridContainer.style.gridTemplateColumns = width + 'px 1fr ' + tocWidth;

          // Re-enable transitions after paint
          requestAnimationFrame(function () {
            requestAnimationFrame(function () {
              sidebar.style.transition = '';
              gridContainer.style.transition = '';
            });
          });
        }
      }
    }

    const collapsedSections = getCollapsedSections();

    // DISABLE transitions before applying state
    const allSections = document.querySelectorAll('.nav-section');
    allSections.forEach((section) => {
      // Disable both chevron and content transitions
      const chevron = section.querySelector('.nav-section-chevron');
      const content = section.querySelector('.nav-section-content');
      
      if (chevron) chevron.style.transition = 'none';
      if (content) content.style.transition = 'none';
    });

    // Expand all sections NOT in the collapsed list
    allSections.forEach((section) => {
      const sectionId = section.getAttribute('data-section');
      if (sectionId && !collapsedSections.includes(sectionId)) {
        section.classList.add('expanded');
        const button = section.querySelector('.nav-section-header');
        if (button) button.setAttribute('aria-expanded', 'true');
      }
    });

    // RE-ENABLE transitions after browser has painted
    requestAnimationFrame(function () {
      requestAnimationFrame(function () {
        allSections.forEach((section) => {
          const chevron = section.querySelector('.nav-section-chevron');
          const content = section.querySelector('.nav-section-content');
          
          if (chevron) chevron.style.transition = '';
          if (content) content.style.transition = '';
        });
      });
    });
  })();
</script>

<script>
  import { initSidebar } from '../lib/sidebar/index';

  // Wait for DOM to be fully loaded
  document.addEventListener('DOMContentLoaded', () => {
    // Find all sidebar containers and initialize each one's search
    const containers = document.querySelectorAll('[data-sidebar-context]');
    containers.forEach((container) => {
      const context = container.getAttribute('data-sidebar-context');
      const searchInputId = `sidebar-search-${context}`;
      const searchInput = document.getElementById(searchInputId);
      if (searchInput) {
        initSidebar(searchInputId);
      }
    });
  });

  // Re-initialize on Astro navigation
  document.addEventListener('astro:after-swap', () => {
    // Find all sidebar search inputs and initialize each one
    const searchInputs = document.querySelectorAll('[id^="sidebar-search-"]');
    searchInputs.forEach((input) => {
      initSidebar(input.id);
    });
  });
</script>

<style>
  .sidebar-container {
    position: relative;
    display: flex;
    flex-direction: row;
    height: 100%;
  }

  .sidebar-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-nav {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 1rem;
  }

  /* Resize Handle */
  .resize-handle {
    width: 4px;
    cursor: col-resize;
    background: transparent;
    transition: background-color 0.15s ease;
    flex-shrink: 0;
  }

  .resize-handle:hover {
    background-color: var(--color-border);
  }

  .resize-handle:active {
    background-color: var(--color-accent);
  }

  /* Search Highlighting */
  :global(.search-highlight) {
    background-color: var(--color-accent-bg);
    color: var(--color-accent);
    font-weight: 600;
    padding: 0 0.125rem;
    border-radius: 0.125rem;
  }

  /* Dark mode divider visibility */
  :global(.dark) .bg-border {
    background-color: var(--color-text-tertiary) !important;
  }

  /* Focus states for static links */
  /* :focus works with :global(), JS-added data-focused also needs :global() */
  :global(.nav-item):focus {
    background-color: rgba(220, 38, 38, 0.15) !important;
    box-shadow: inset 0 0 0 2px #dc2626 !important;
    color: var(--color-text-primary) !important;
  }

  /* JS-added attribute - use :global() for entire selector */
  :global(.nav-item[data-focused='true']) {
    background-color: rgba(220, 38, 38, 0.15) !important;
    box-shadow: inset 0 0 0 2px #dc2626 !important;
    color: var(--color-text-primary) !important;
  }

  :global(.dark .nav-item):focus {
    background-color: rgba(248, 113, 113, 0.2) !important;
    box-shadow: inset 0 0 0 2px #f87171 !important;
  }

  :global(.dark .nav-item[data-focused='true']) {
    background-color: rgba(248, 113, 113, 0.2) !important;
    box-shadow: inset 0 0 0 2px #f87171 !important;
  }
</style>
