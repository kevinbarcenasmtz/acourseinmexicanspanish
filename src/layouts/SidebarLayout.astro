---
import { getCollection } from 'astro:content';

// SidebarLayout.astro - layout with collapsible sidebar for lesson navigation
// src/layouts/SidebarLayout.astro
interface Props {
  title: string;
  currentLesson?: string;
}
const { title, currentLesson } = Astro.props;

// get all the lessons from the content collection
const allLessons: any = await getCollection('lessons');

// sort by order & transform to sidebar format
const lessons = allLessons
  .sort((a: any, b: any) => a.data.order - b.data.order)
  .map((lesson: any): { id: any; title: any; section: any } => ({
    id: lesson.slug,
    title: lesson.data.title,
    section: lesson.data.section,
  }));

// group lessons by section
const lessonsBySection = lessons.reduce(
  (acc: Record<string, typeof lessons>, lesson: any) => {
    if (!acc[lesson.section]) {
      acc[lesson.section] = [];
    }
    acc[lesson.section].push(lesson);
    return acc;
  },
  {} as Record<string, typeof lessons>
);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>A Course in Mexican Spanish</title>
    <link rel="stylesheet" href="/src/styles/global.css" />
  </head>
  <body class="bg-zinc-50 dark:bg-zinc-950">
    <!-- Main Container -->
    <main
      class="relative flex h-screen max-h-screen flex-col overflow-y-hidden p-2 transition-all duration-200 ease-in-out"
    >
      <!-- Mobile Message -->
      <div
        class="flex h-full w-full flex-col items-center justify-center p-8 text-center md:hidden"
      >
        <p class="text-2xl font-semibold text-zinc-600 dark:text-zinc-400">
          Please use a desktop browser
        </p>
        <p class="mt-4 text-sm text-zinc-500 dark:text-zinc-500">
          This learning resource is optimized for desktop viewing
        </p>
      </div>

      <!-- Desktop Content -->
      <div class="hidden h-full w-full flex-col md:flex">
        <!-- Header -->
        <div class="flex flex-row items-center gap-4 p-4">
          <div
            class="flex h-8 w-8 items-center justify-center rounded-lg bg-emerald-600 text-white font-bold"
          >
            ES
          </div>
          <div class="h-6 w-px -skew-x-12 bg-zinc-300 dark:bg-zinc-700"></div>
          <p class="text-lg font-semibold text-zinc-700 dark:text-zinc-300">Mexican Spanish</p>
        </div>

        <!-- Main Content Wrapper -->
        <div
          class="group flex min-h-0 w-full flex-1 flex-row gap-4 p-2 transition-all duration-200 ease-in-out"
        >
          <!-- Sidebar Section -->
          <div
            id="sidebar"
            class="sidebar-container relative h-full min-w-68 rounded-xl bg-white dark:bg-zinc-900 p-2 transition-all duration-200 ease-in-out"
          >
            <!-- Hover-Reveal Panel -->
            <div
              id="sidebar-panel"
              class="sidebar-panel absolute left-0 h-full w-full rounded-lg transition-all duration-200 ease-in-out"
            >
              <div class="flex h-full flex-col gap-2">
                <!-- Search Bar -->
                <div class="relative w-full rounded-lg bg-zinc-100 dark:bg-zinc-800">
                  <div class="pointer-events-none absolute inset-y-0 left-3 flex items-center">
                    <svg
                      class="h-4 w-4 text-zinc-500"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                  </div>
                  <input
                    type="text"
                    placeholder="Search lessons..."
                    class="w-full rounded-lg bg-transparent py-2 pr-3 pl-9 text-sm placeholder:text-zinc-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                  />
                </div>

                <!-- Navigation Menu -->
                <nav class="flex flex-1 flex-col gap-1 overflow-y-auto">
                  {
                    Object.entries(lessonsBySection).map(
                      ([section, sectionLessons]: [string, typeof lessons]) => (
                        <div class="mt-2 mb-2">
                          <p class="px-3 py-2 text-xs font-semibold text-zinc-500 dark:text-zinc-400">
                            {section}
                          </p>
                          <div class="space-y-1">
                            {sectionLessons.map((lesson: any) => (
                              <a
                                href={`/lessons/${lesson.id}`}
                                class:list={[
                                  'flex w-full items-center justify-between rounded-lg px-3 py-2 text-left text-sm transition-colors',
                                  currentLesson === lesson.id
                                    ? 'bg-emerald-100 text-emerald-900 dark:bg-emerald-900 dark:text-emerald-100'
                                    : 'text-zinc-700 hover:bg-zinc-100 dark:text-zinc-300 dark:hover:bg-zinc-800',
                                ]}
                              >
                                <span class="truncate">{lesson.title}</span>
                              </a>
                            ))}
                          </div>
                        </div>
                      )
                    )
                  }
                </nav>

                <!-- Bottom Actions -->
                <div class="space-y-1 border-t border-zinc-200 dark:border-zinc-800 pt-2">
                  <a
                    href="/"
                    class="flex w-full items-center gap-2 rounded-lg px-3 py-2 text-sm text-zinc-600 hover:bg-zinc-100 dark:text-zinc-400 dark:hover:bg-zinc-800 transition-colors"
                  >
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
                      ></path>
                    </svg>
                    <span>Home</span>
                  </a>
                </div>
              </div>
            </div>
          </div>

          <!-- Main Content Area -->
          <div
            class="h-full w-full rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-900 transition-all duration-200 ease-in-out overflow-y-auto"
          >
            <!-- Toggle Button -->
            <div class="sidebar-trigger max-w-max p-2">
              <button
                id="sidebar-toggle"
                class="rounded-lg p-2 hover:bg-zinc-100 dark:hover:bg-zinc-800"
                aria-label="Toggle sidebar"
              >
                <svg
                  id="sidebar-icon"
                  class="text-zinc-600 dark:text-zinc-400 transition-transform duration-200"
                  width="20"
                  height="20"
                  viewBox="0 0 16 16"
                  fill="currentColor"
                >
                  <path
                    d="M14 2a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1zM2 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2z"
                  ></path>
                  <rect
                    id="sidebar-bar"
                    class="transition-all duration-150 ease-in-out"
                    x="2"
                    y="3"
                    width="6"
                    height="10"
                    rx="1"></rect>
                </svg>
              </button>
            </div>

            <!-- Page Content -->
            <div class="px-8 py-6">
              <slot />
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Sidebar toggle logic
      const sidebar = document.getElementById('sidebar');
      const sidebarPanel = document.getElementById('sidebar-panel');
      const toggleButton = document.getElementById('sidebar-toggle');
      const trigger = document.querySelector('.sidebar-trigger');
      const sidebarBar = document.getElementById('sidebar-bar');

      let isCollapsed = false;

      // Toggle sidebar on button click
      toggleButton?.addEventListener('click', () => {
        isCollapsed = !isCollapsed;
        updateSidebarState();
      });

      // Hover reveal functionality
      let hoverTimeout: number;

      trigger?.addEventListener('mouseenter', () => {
        if (isCollapsed) {
          clearTimeout(hoverTimeout);
          sidebarPanel?.classList.add('revealed');
        }
      });

      sidebarPanel?.addEventListener('mouseenter', () => {
        if (isCollapsed) {
          clearTimeout(hoverTimeout);
        }
      });

      sidebarPanel?.addEventListener('mouseleave', () => {
        if (isCollapsed) {
          hoverTimeout = window.setTimeout(() => {
            sidebarPanel?.classList.remove('revealed');
          }, 100);
        }
      });

      function updateSidebarState(): void {
        if (isCollapsed) {
          sidebar?.classList.add('collapsed');
          sidebarBar?.setAttribute('width', '3');
        } else {
          sidebar?.classList.remove('collapsed');
          sidebarPanel?.classList.remove('revealed');
          sidebarBar?.setAttribute('width', '6');
        }
      }

      // Search functionality
      const searchInput = document.querySelector('input[type="text"]') as HTMLInputElement;
      const lessonLinks = document.querySelectorAll('nav a');

      searchInput?.addEventListener('input', (e) => {
        const query = (e.target as HTMLInputElement).value.toLowerCase();

        lessonLinks.forEach((link) => {
          const text = link.textContent?.toLowerCase() || '';
          const parent = link.closest('div');

          if (text.includes(query)) {
            link.classList.remove('hidden');
            parent?.classList.remove('hidden');
          } else {
            link.classList.add('hidden');

            // Hide section if all lessons are hidden
            const section = link.closest('.space-y-1');
            const visibleLinks = section?.querySelectorAll('a:not(.hidden)');
            if (visibleLinks?.length === 0) {
              parent?.classList.add('hidden');
            }
          }
        });
      });
    </script>

    <style>
      /* Sidebar collapsed state */
      .sidebar-container.collapsed {
        margin-left: -272px;
      }

      /* Hover reveal when collapsed */
      .sidebar-container.collapsed .sidebar-panel.revealed {
        position: absolute;
        left: 240px;
        width: 272px;
        height: 91.666667%; /* h-11/12 */
        transform: translateY(3rem);
        background: white;
        border: 1px solid rgb(228 228 231 / 0.5);
        border-radius: 0.5rem;
        padding: 0.5rem 0.5rem 0.5rem 1.5rem;
        z-index: 10;
      }

      /* Dark mode */
      .dark .sidebar-container.collapsed .sidebar-panel.revealed {
        background: rgb(24 24 27);
        border-color: rgb(63 63 70 / 0.5);
      }

      /* Smooth transitions */
      .sidebar-container,
      .sidebar-panel {
        transition: all 200ms ease-in-out;
      }

      /* Icon animation on hover */
      .sidebar-trigger:hover #sidebar-bar {
        width: 3px;
      }

      .sidebar-container.collapsed .sidebar-trigger:hover #sidebar-bar {
        width: 6px;
      }
    </style>
  </body>
</html>
