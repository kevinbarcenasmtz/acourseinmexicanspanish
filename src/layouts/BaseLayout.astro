---
/**
 * BaseLayout.astro
 *
 * The foundational layout providing:
 * - HTML document shell with meta tags
 * - Font preloading for performance
 * - 3-column CSS Grid (left sidebar | content | right sidebar)
 * - Responsive breakpoints (mobile/tablet/desktop)
 * - Dark mode support with localStorage persistence
 * - Sidebar toggle for tablet/desktop
 * - Mobile drawer overlay infrastructure
 * - Skip link for accessibility
 *
 * Slots:
 * - default: Main content area
 * - left-sidebar: Navigation (defaults to LeftSidebar)
 * - right-sidebar: Table of Contents (empty by default, pages fill this)
 * - mobile-nav: Mobile navigation drawer content
 * - mobile-toc: Mobile ToC drawer content
 * - header: Header override (defaults to Header component)
 */

 import '../styles/global.css';
import Header from '../components/Header.astro';
import LeftSidebar from '../components/LeftSidebar.astro';

interface Props {
  title: string;
  description?: string;
}

const {
  title,
  description = 'A comprehensive Mexican Spanish learning resource for English speakers',
} = Astro.props;

const siteTitle = 'A Course in Mexican Spanish';
const fullTitle = title === siteTitle ? title : `${title} | ${siteTitle}`;
const currentPath = Astro.url.pathname;
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />

    <title>{fullTitle}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Font Preloading -->
    <link rel="preload" href="/fonts/chilanga-regular.ttf" as="font" type="font/ttf" crossorigin />
    <link rel="preload" href="/fonts/atkinson-regular.ttf" as="font" type="font/ttf" crossorigin />

    <!-- Dark Mode & Sidebar State: Prevent flash -->
    <script is:inline>
      (function () {
        // Dark mode
        const storedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (storedTheme === 'dark' || (!storedTheme && prefersDark)) {
          document.documentElement.classList.add('dark');
        }

        // Sidebar state - apply immediately to prevent flash
        const sidebarVisible = localStorage.getItem('sidebar-visible');
        const isDesktop = window.innerWidth >= 1024;
        const isTablet = window.innerWidth >= 640 && window.innerWidth < 1024;

        // Default: hidden on tablet, visible on desktop
        const shouldBeVisible = sidebarVisible === null ? isDesktop : sidebarVisible === 'true';

        if (isTablet && shouldBeVisible) {
          document.documentElement.classList.add('sidebar-visible-init');
        } else if (isDesktop && !shouldBeVisible) {
          document.documentElement.classList.add('sidebar-collapsed-init');
        }
      })();
    </script>
  </head>

  <body class="bg-primary text-primary min-h-screen antialiased">
    <!-- Skip Link (Accessibility) -->
    <a href="#main-content" class="skip-link"> Skip to main content </a>

    <!-- App Shell -->
    <div class="app-shell">
      <!-- Header -->
      <slot name="header">
        <Header siteTitle={siteTitle} />
      </slot>

      <!-- Main Layout Grid -->
      <div class="app-body" id="app-body">
        <!-- Left Sidebar (Navigation) -->
        <aside
          id="left-sidebar"
          class="app-sidebar-left custom-scrollbar"
          aria-label="Site navigation"
        >
          <slot name="left-sidebar">
            <LeftSidebar currentPath={currentPath} context="desktop" />
          </slot>
        </aside>

        <!-- Main Content Area -->
        <main id="main-content" class="app-content custom-scrollbar">
          <div class="content-wrapper">
            <slot />
          </div>
        </main>

        <!-- Right Sidebar (Table of Contents) -->
        <aside
          id="right-sidebar"
          class="app-sidebar-right custom-scrollbar"
          aria-label="Table of contents"
        >
          <slot name="right-sidebar">
            <!-- Empty by default - pages pass RightSidebar here -->
          </slot>
        </aside>
      </div>
    </div>

    <!-- Mobile Drawer Overlay -->
    <div id="drawer-overlay" class="drawer-overlay" aria-hidden="true"></div>

    <!-- Mobile Left Drawer -->
    <div
      id="left-drawer"
      class="drawer drawer-left custom-scrollbar"
      role="dialog"
      aria-modal="true"
      aria-label="Navigation menu"
    >
      <div class="drawer-header">
        <span class="font-display text-lg">Navigation</span>
        <button
          type="button"
          class="theme-toggle"
          aria-label="Close navigation menu"
          data-close-drawer="left"
        >
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="drawer-body">
        <slot name="mobile-nav">
          <LeftSidebar currentPath={currentPath} context="mobile" />
        </slot>
      </div>
    </div>

    <!-- Mobile Right Drawer (ToC) -->
    <div
      id="right-drawer"
      class="drawer drawer-right custom-scrollbar"
      role="dialog"
      aria-modal="true"
      aria-label="Table of contents"
    >
      <div class="drawer-header">
        <span class="font-display text-lg">On this page</span>
        <button
          type="button"
          class="theme-toggle"
          aria-label="Close table of contents"
          data-close-drawer="right"
        >
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="drawer-body">
        <slot name="mobile-toc">
          <!-- Empty by default - pages pass RightSidebar here -->
        </slot>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      // ==========================================================================
      // Mobile Drawer Functionality
      // ==========================================================================

      const overlay = document.getElementById('drawer-overlay');
      const leftDrawer = document.getElementById('left-drawer');
      const rightDrawer = document.getElementById('right-drawer');
      const menuToggle = document.getElementById('mobile-menu-toggle');
      const tocToggle = document.getElementById('mobile-toc-toggle');

      // Focus trap state
      let focusTrapActive = false;
      let firstFocusableElement: HTMLElement | null = null;
      let lastFocusableElement: HTMLElement | null = null;

      function getFocusableElements(container: HTMLElement): HTMLElement[] {
        const focusableSelectors = [
          'a[href]',
          'button:not([disabled])',
          'textarea:not([disabled])',
          'input:not([disabled])',
          'select:not([disabled])',
          '[tabindex]:not([tabindex="-1"])',
        ].join(',');
        return Array.from(container.querySelectorAll(focusableSelectors)) as HTMLElement[];
      }

      function setupFocusTrap(drawer: HTMLElement) {
        const focusableElements = getFocusableElements(drawer);
        if (focusableElements.length === 0) return;
        firstFocusableElement = focusableElements[0];
        lastFocusableElement = focusableElements[focusableElements.length - 1];
        focusTrapActive = true;
      }

      function handleFocusTrap(e: KeyboardEvent) {
        if (!focusTrapActive || e.key !== 'Tab') return;
        if (e.shiftKey) {
          if (document.activeElement === firstFocusableElement) {
            e.preventDefault();
            lastFocusableElement?.focus();
          }
        } else {
          if (document.activeElement === lastFocusableElement) {
            e.preventDefault();
            firstFocusableElement?.focus();
          }
        }
      }

      function removeFocusTrap() {
        focusTrapActive = false;
        firstFocusableElement = null;
        lastFocusableElement = null;
      }

      function openDrawer(drawer: HTMLElement | null, toggle: HTMLElement | null) {
        if (!drawer || !overlay) return;
        drawer.classList.add('open');
        overlay.classList.add('visible');
        document.body.classList.add('body-scroll-lock');
        toggle?.setAttribute('aria-expanded', 'true');
        setupFocusTrap(drawer);
        const focusable = drawer.querySelector('button, a, input');
        (focusable as HTMLElement)?.focus();
      }

      function closeDrawer(drawer: HTMLElement | null, toggle: HTMLElement | null) {
        if (!drawer || !overlay) return;
        drawer.classList.remove('open');
        overlay.classList.remove('visible');
        document.body.classList.remove('body-scroll-lock');
        toggle?.setAttribute('aria-expanded', 'false');
        toggle?.focus();
        removeFocusTrap();
      }

      function closeAllDrawers() {
        closeDrawer(leftDrawer, menuToggle);
        closeDrawer(rightDrawer, tocToggle);
      }

      // Mobile menu toggle
      menuToggle?.addEventListener('click', () => {
        const isOpen = leftDrawer?.classList.contains('open');
        if (isOpen) {
          closeDrawer(leftDrawer, menuToggle);
        } else {
          closeAllDrawers();
          openDrawer(leftDrawer, menuToggle);
        }
      });

      // ToC toggle
      tocToggle?.addEventListener('click', () => {
        const isOpen = rightDrawer?.classList.contains('open');
        if (isOpen) {
          closeDrawer(rightDrawer, tocToggle);
        } else {
          closeAllDrawers();
          openDrawer(rightDrawer, tocToggle);
        }
      });

      // Close buttons inside drawers
      document.querySelectorAll('[data-close-drawer]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const side = (btn as HTMLElement).dataset.closeDrawer;
          if (side === 'left') closeDrawer(leftDrawer, menuToggle);
          if (side === 'right') closeDrawer(rightDrawer, tocToggle);
        });
      });

      // Overlay click closes
      overlay?.addEventListener('click', closeAllDrawers);

      // Escape key closes drawers
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeAllDrawers();
        }
        handleFocusTrap(e);
      });

      // Close drawer when clicking ToC links (mobile)
      rightDrawer?.querySelectorAll('a').forEach((link) => {
        link.addEventListener('click', () => {
          setTimeout(() => closeDrawer(rightDrawer, tocToggle), 100);
        });
      });

      // ==========================================================================
      // Sidebar Toggle Functionality (Tablet/Desktop)
      // ==========================================================================

      (function initSidebarToggle() {
        const STORAGE_KEY = 'sidebar-visible';
        const appBody = document.getElementById('app-body');
        const sidebarToggle = document.getElementById('sidebar-toggle');

        // Early return if elements don't exist
        if (!appBody || !sidebarToggle) return;

        // Create const references that TypeScript trusts in nested functions
        const body = appBody;
        const toggle = sidebarToggle;

        function isTablet(): boolean {
          return window.innerWidth >= 640 && window.innerWidth < 1024;
        }

        function isDesktop(): boolean {
          return window.innerWidth >= 1024;
        }

        function getStoredState(): boolean {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored === null) {
            return isDesktop();
          }
          return stored === 'true';
        }

        function setSidebarState(isVisible: boolean): void {
          document.documentElement.classList.remove(
            'sidebar-visible-init',
            'sidebar-collapsed-init'
          );

          if (isTablet()) {
            body.classList.toggle('sidebar-visible', isVisible);
            body.classList.remove('sidebar-collapsed');
          } else if (isDesktop()) {
            body.classList.toggle('sidebar-collapsed', !isVisible);
            body.classList.remove('sidebar-visible');
          } else {
            body.classList.remove('sidebar-visible', 'sidebar-collapsed');
          }

          toggle.setAttribute('aria-expanded', String(isVisible));

          const openIcon = toggle.querySelector('.sidebar-icon-open');
          const closedIcon = toggle.querySelector('.sidebar-icon-closed');
          if (openIcon && closedIcon) {
            openIcon.classList.toggle('hidden', !isVisible);
            closedIcon.classList.toggle('hidden', isVisible);
          }

          document.body.classList.toggle('sidebar-collapsed', !isVisible);
        }

        function toggleSidebar(): void {
          const isCurrentlyVisible = isTablet()
            ? body.classList.contains('sidebar-visible')
            : !body.classList.contains('sidebar-collapsed');

          const newState = !isCurrentlyVisible;
          setSidebarState(newState);
          localStorage.setItem(STORAGE_KEY, String(newState));
        }

        function init(): void {
          const shouldBeVisible = getStoredState();
          setSidebarState(shouldBeVisible);
        }

        let resizeTimeout: number;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = window.setTimeout(() => {
            const shouldBeVisible = getStoredState();
            setSidebarState(shouldBeVisible);
          }, 100);
        });

        toggle.addEventListener('click', toggleSidebar);

        document.addEventListener('keydown', (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
            e.preventDefault();
            toggleSidebar();
          }
        });

        init();
      })();
    </script>

    <style>
      .drawer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid var(--color-border);
        position: sticky;
        top: 0;
        background-color: var(--color-bg-primary);
        z-index: 1;
      }

      .drawer-body {
        padding: 1rem;
      }
    </style>
  </body>
</html>