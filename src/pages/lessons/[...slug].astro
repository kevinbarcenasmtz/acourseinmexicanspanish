---
/**
 * [...slug].astro
 *
 * Dynamic lesson page that:
 * - Fetches lesson content from collection
 * - Extracts headings for Table of Contents
 * - Calculates previous/next navigation
 * - Renders using LessonLayout
 */

import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import LessonLayout from '../../layouts/LessonLayout.astro';

// Generate paths for all lessons
export async function getStaticPaths() {
  const lessons = await getCollection('lessons');
  return lessons.map((lesson) => ({
    params: { slug: lesson.slug },
    props: { lesson },
  }));
}

interface Props {
  lesson: CollectionEntry<'lessons'>;
}

const { lesson } = Astro.props;

// Render the lesson content and extract headings
const { Content, headings } = await lesson.render();

// Get all lessons sorted by order for navigation
const allLessons = await getCollection('lessons');
const sortedLessons = allLessons.sort((a, b) => a.data.order - b.data.order);

// Find previous and next lessons
const currentIndex = sortedLessons.findIndex((l) => l.slug === lesson.slug);
const previousLesson =
  currentIndex > 0
    ? {
        slug: sortedLessons[currentIndex - 1].slug,
        title: sortedLessons[currentIndex - 1].data.title,
      }
    : null;
const nextLesson =
  currentIndex < sortedLessons.length - 1
    ? {
        slug: sortedLessons[currentIndex + 1].slug,
        title: sortedLessons[currentIndex + 1].data.title,
      }
    : null;
---

<LessonLayout
  title={lesson.data.title}
  description={lesson.data.description}
  section={lesson.data.section}
  headings={headings}
  vocabulary={lesson.data.vocabulary}
  grammarTopics={lesson.data.grammarTopics}
  previousLesson={previousLesson}
  nextLesson={nextLesson}
>
  <Content />
</LessonLayout>
